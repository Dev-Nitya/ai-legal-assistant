name: Deploy AI Legal Assistant to AWS

on:
  push:
    branches: [master]
    paths:
      - "infrastructure/**"
      - "backend/**"
      - ".github/workflows/**"
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      force_infrastructure_update:
        description: "Force infrastructure update"
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: us-east-1
  STACK_NAME: ai-legal-assistant-infra
  APPLICATION_NAME: ai-legal-assistant

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      infrastructure-changed: ${{ steps.changes.outputs.infrastructure }}
      backend-changed: ${{ steps.changes.outputs.backend }}
      force-infrastructure: ${{ github.event.inputs.force_infrastructure_update == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed files
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "infrastructure=true" >> $GITHUB_OUTPUT
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            if git diff --name-only HEAD^ HEAD | grep -E '^infrastructure/|^\.github/workflows/' > /dev/null; then
              echo "infrastructure=true" >> $GITHUB_OUTPUT
            else
              echo "infrastructure=false" >> $GITHUB_OUTPUT
            fi
            if git diff --name-only HEAD^ HEAD | grep -E '^backend/' > /dev/null; then
              echo "backend=true" >> $GITHUB_OUTPUT
            else
              echo "backend=false" >> $GITHUB_OUTPUT
            fi
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend-changed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Basic syntax check
        run: |
          cd backend
          python -m py_compile main.py

      - name: Lint code
        run: |
          cd backend
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

  deploy-infrastructure:
    name: Deploy Infrastructure (No ECS Service)
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    if: |
      always() &&
      (needs.detect-changes.outputs.infrastructure-changed == 'true' ||
       needs.detect-changes.outputs.force-infrastructure == 'true') &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    outputs:
      bucket-name: ${{ steps.deploy-stack.outputs.bucket-name }}
      database-endpoint: ${{ steps.deploy-stack.outputs.database-endpoint}}
      redis-endpoint: ${{ steps.deploy-stack.outputs.redis-endpoint }}
      stack-updated: ${{ steps.deploy-stack.outputs.stack-updated }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # --- Safer removal of ECSService: create a full copy, then write a cleaned template ---
      - name: Safely remove ECSService from CloudFormation (creates cleaned template)
        run: |
          # keep a full copy to restore later
          cp infrastructure/cloudformation.yml infrastructure/cloudformation.full.yml

          # install pyyaml so the inline script can parse safely
          python -m pip install --upgrade pip
          python -m pip install pyyaml

          # load template, remove Resources.ECSService if present, write back
          python - <<'PY'
          import yaml, sys
          p = "infrastructure/cloudformation.yml"
          with open(p, "r") as f:
              doc = yaml.safe_load(f)
          if isinstance(doc, dict):
              resources = doc.get("Resources")
              if isinstance(resources, dict) and "ECSService" in resources:
                  resources.pop("ECSService")
                  doc["Resources"] = resources
                  with open(p, "w") as out:
                      yaml.safe_dump(doc, out, default_flow_style=False, sort_keys=False)
                  print("Removed ECSService from template")
              else:
                  print("ECSService not present; no change")
          else:
              print("Template not a dict; no change")
          PY

      - name: Check if stack exists
        id: check-stack
        run: |
          if aws cloudformation describe-stacks --stack-name ${{ env.STACK_NAME }} > /dev/null 2>&1; then
            echo "stack-exists=true" >> $GITHUB_OUTPUT
            echo "Stack exists, will update if needed"
          else
            echo "stack-exists=false" >> $GITHUB_OUTPUT
            echo "Stack does not exist, will create"
          fi

      - name: Deploy CloudFormation stack (no ECS Service)
        id: deploy-stack
        run: |
          echo "Deploying CloudFormation stack (no ECS Service)..."
          DEPLOY_OUTPUT=$(aws cloudformation deploy \
            --template-file infrastructure/cloudformation.yml \
            --stack-name ${{ env.STACK_NAME }} \
            --parameter-overrides \
              Environment=production \
              DBPassword="${{ secrets.DB_PASSWORD }}" \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ${{ env.AWS_REGION }} \
            --no-fail-on-empty-changeset 2>&1 || echo "DEPLOY_FAILED")

          if echo "$DEPLOY_OUTPUT" | grep -q "No changes to deploy"; then
            echo "stack-updated=false" >> $GITHUB_OUTPUT
            echo "No infrastructure changes detected"
          elif echo "$DEPLOY_OUTPUT" | grep -q "DEPLOY_FAILED"; then
            echo "Deployment failed:"
            echo "$DEPLOY_OUTPUT"
            exit 1
          else
            echo "stack-updated=true" >> $GITHUB_OUTPUT
            echo "Infrastructure updated successfully"
          fi

          BUCKET_NAME=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query 'Stacks[0].Outputs[?OutputKey==`BucketName`].OutputValue' \
            --output text \
            --region ${{ env.AWS_REGION }})
          echo "bucket-name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          DB_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query 'Stacks[0].Outputs[?OutputKey==`DatabaseEndpoint`].OutputValue' \
            --output text \
            --region ${{ env.AWS_REGION }})
          echo "database-endpoint=$DB_ENDPOINT" >> $GITHUB_OUTPUT
          REDIS_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query 'Stacks[0].Outputs[?OutputKey==`RedisEndpoint`].OutputValue' \
            --output text \
            --region ${{ env.AWS_REGION }})
          echo "redis-endpoint=$REDIS_ENDPOINT" >> $GITHUB_OUTPUT

  build-and-deploy:
    name: Build & Deploy Application
    runs-on: ubuntu-latest
    needs: [detect-changes, test, deploy-infrastructure]
    if: |
      always() &&
      needs.detect-changes.outputs.backend-changed == 'true' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          echo "Building Docker image..."
          docker build -t ${{ env.APPLICATION_NAME }}:${{ github.sha }} ./backend
          docker tag ${{ env.APPLICATION_NAME }}:${{ github.sha }} ${{ env.APPLICATION_NAME }}:latest
          echo "Docker image built successfully"

      - name: Test Docker image
        run: |
          echo "Testing Docker image..."
          docker run --rm ${{ env.APPLICATION_NAME }}:latest python -c "import main; print('Docker image works!')"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get ECR Repo URI
        id: get_ecr_repo
        run: |
          REPO=$(aws cloudformation describe-stacks --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='EcrRepoUri'].OutputValue" --output text)
          echo "ecr_repo=$REPO" >> $GITHUB_OUTPUT

      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin ${{ steps.get_ecr_repo.outputs.ecr_repo }}

      - name: Tag and push Docker image to ECR
        run: |
          docker tag ${{ env.APPLICATION_NAME }}:latest ${{ steps.get_ecr_repo.outputs.ecr_repo }}:latest
          docker push ${{ steps.get_ecr_repo.outputs.ecr_repo }}:latest

      # --- Restore original template (with ECSService) and deploy full stack ---
      - name: Restore ECSService in CloudFormation
        run: |
          if [ -f infrastructure/cloudformation.full.yml ]; then
            mv infrastructure/cloudformation.full.yml infrastructure/cloudformation.yml
          else
            echo "No backup template found; assuming original file present"
          fi

      - name: Deploy CloudFormation stack (with ECS Service)
        run: |
          echo "Deploying CloudFormation stack (with ECS Service)..."
          aws cloudformation deploy \
            --template-file infrastructure/cloudformation.yml \
            --stack-name ${{ env.STACK_NAME }} \
            --parameter-overrides \
              Environment=production \
              DBPassword="${{ secrets.DB_PASSWORD }}" \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ${{ env.AWS_REGION }} \
            --no-fail-on-empty-changeset

      - name: Update ECS service to use new image
        run: |
          CLUSTER=ai-legal-assistant-cluster
          SERVICE=$(aws ecs list-services --cluster $CLUSTER --query "serviceArns[0]" --output text)
          aws ecs update-service --cluster $CLUSTER --service $SERVICE --force-new-deployment

  create-deployment-summary:
    name: Create Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-infrastructure, build-and-deploy]
    if: always()

    steps:
      - name: Create deployment summary
        run: |
          echo "## 🚀 Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes Detected:" >> $GITHUB_STEP_SUMMARY
          echo "- **Infrastructure**: ${{ needs.detect-changes.outputs.infrastructure-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Code**: ${{ needs.detect-changes.outputs.backend-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Force Update**: ${{ needs.detect-changes.outputs.force-infrastructure }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status:" >> $GITHUB_STEP_SUMMARY
          echo "- **Infrastructure**: ${{ needs.deploy-infrastructure.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Application Build**: ${{ needs.build-and-deploy.result }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-infrastructure.outputs.bucket-name }}" != "" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Resources:" >> $GITHUB_STEP_SUMMARY
            echo "- **S3 Bucket**: ${{ needs.deploy-infrastructure.outputs.bucket-name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Database**: ${{ needs.deploy-infrastructure.outputs.database-endpoint }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Redis Cache**: ${{ needs.deploy-infrastructure.outputs.redis-endpoint }}" >> $GITHUB_STEP_SUMMARY
            echo "- **AWS Region**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### 📋 Next Steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. **Set environment variables for local testing**:" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "   export AWS_RDS_ENDPOINT=${{ needs.deploy-infrastructure.outputs.database-endpoint }}" >> $GITHUB_STEP_SUMMARY
            echo "   export AWS_RDS_PASSWORD=your-db-password" >> $GITHUB_STEP_SUMMARY
            echo "   export AWS_ELASTICACHE_ENDPOINT=${{ needs.deploy-infrastructure.outputs.redis-endpoint }}" >> $GITHUB_STEP_SUMMARY
            echo "   export ENVIRONMENT=production" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "2. **Upload documents**: \`aws s3 cp backend/documents/ s3://${{ needs.deploy-infrastructure.outputs.bucket-name }}/legal-documents/ --recursive\`" >> $GITHUB_STEP_SUMMARY
            echo "3. **Test locally**: \`docker-compose up\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Show ALB DNS
        run: |
          ALB_DNS=$(aws cloudformation describe-stacks --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='AlbDNS'].OutputValue" --output text)
          echo "### 🚀 App URL: http://$ALB_DNS" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Success
        if: |
          needs.deploy-infrastructure.result == 'success' ||
          (needs.deploy-infrastructure.result == 'skipped' && needs.build-and-deploy.result == 'success')
        run: |
          echo "✅ Deployment completed successfully!"

      - name: Deployment Failure
        if: |
          needs.deploy-infrastructure.result == 'failure' ||
          needs.build-and-deploy.result == 'failure'
        run: |
          echo "❌ Deployment failed!"
          exit 1
